flowchart TD
    %% --- ESTILOS ONE DARK PRO ---
    classDef base fill:#282c34,color:#abb2bf,stroke-width:2px;
    classDef process fill:#282c34,stroke:#61afef,color:#abb2bf,stroke-width:2px;
    classDef decision fill:#282c34,stroke:#c678dd,color:#abb2bf,stroke-width:2px;
    classDef terminator fill:#282c34,stroke:#e06c75,color:#abb2bf,stroke-width:2px;
    classDef io fill:#282c34,stroke:#98c379,color:#abb2bf,stroke-width:2px;
    linkStyle default stroke:#abb2bf,stroke-width:2px;

    Start([Inicio]) --> PatchPy313[Aplicar Parche Py3.13<br/>Mock modules: aifc, chunk...]
    PatchPy313 --> InitPaths[Crear Directorios: <br/>ESP, GRA, CSV, TXT]
    InitPaths --> InputFiles[/"Entrada: Lista de archivos (sep por coma)"/]

    InputFiles --> IsQ{"¿Entrada == 'Q'?"}
    IsQ -- Sí --> End([Fin])
    IsQ -- No --> LoopFiles[Iterar sobre lista de archivos]

    subgraph ProcessFile ["Procesamiento Individual"]
        direction TB
        LoopFiles --> SearchRecursive[Buscar archivo recursivamente]
        SearchRecursive --> Found{"¿Encontrado?"}
        Found -- No --> Skip[Saltar]
        Found -- Sí --> SafeConv[Convertir a WAV Seguro <br/>(subprocess ffmpeg)]
        SafeConv --> LibrosaLoad[Cargar Librosa + FFT]
        LibrosaLoad --> CalcDB[Calcular dB y Promedios]
        CalcDB --> ExportData[Exportar CSV/TXT]
        ExportData --> AddToList[Agregar a lista de datos]
    end

    AddToList --> LoopFiles
    Skip --> LoopFiles
    
    LoopFiles -- "Todos procesados" --> CheckCount{"¿Archivos >= 2?"}
    
    CheckCount -- No --> ErrMin[Error: Mínimo 2 archivos] --> InputFiles
    CheckCount -- Sí --> GenPlots(Generar Visualizaciones)

    subgraph Viz ["Visualización"]
        direction TB
        GenPlots --> PlotComp[Gráfica Comparativa Matplotlib]
        PlotComp --> PlotDiff[Calcular y Graficar Diferencial]
        PlotDiff --> SavePNG[Guardar PNG]
        SavePNG --> SpecShow[Generar Espectrogramas PDF]
        SpecShow --> SavePDF[Guardar PDF]
    end

    SavePDF --> InputFiles

    %% ASIGNACIÓN CLASES
    class Start,End,ErrMin terminator;
    class PatchPy313,InitPaths,LoopFiles,SearchRecursive,SafeConv,LibrosaLoad,CalcDB,ExportData,AddToList,GenPlots,PlotComp,PlotDiff,SavePNG,SpecShow,SavePDF,Skip process;
    class IsQ,Found,CheckCount decision;
    class InputFiles io;

    style ProcessFile fill:#21252b,stroke:#abb2bf,stroke-width:1px
    style Viz fill:#21252b,stroke:#abb2bf,stroke-width:1px
